# Prometheus Alerting Rules for Wazuh MCP Server v3.0.0
# This file contains comprehensive alerting rules for production monitoring

groups:
  # Critical System Alerts
  - name: wazuh-mcp-critical
    rules:
      - alert: WazuhMCPServerDown
        expr: up{job="wazuh-mcp-servers"} == 0
        for: 30s
        labels:
          severity: critical
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "Wazuh MCP Server is down"
          description: "Wazuh MCP Server {{ $labels.instance }} has been down for more than 30 seconds."
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/server-down"
          dashboard_url: "https://grafana.wazuh-mcp.local/d/wazuh-mcp-overview"

      - alert: WazuhMCPHighErrorRate
        expr: rate(http_requests_total{job="wazuh-mcp-servers",status=~"5.."}[5m]) / rate(http_requests_total{job="wazuh-mcp-servers"}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} for {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/high-error-rate"

      - alert: WazuhMCPHighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="wazuh-mcp-servers"}[5m])) > 2
        for: 5m
        labels:
          severity: critical
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is {{ $value }}s for {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/high-response-time"

      - alert: WazuhMCPMemoryUsageHigh
        expr: (process_resident_memory_bytes{job="wazuh-mcp-servers"} / (1024^3)) > 2
        for: 5m
        labels:
          severity: critical
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is {{ $value | humanize1024 }}B for {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/high-memory-usage"

      - alert: WazuhMCPDiskSpacelow
        expr: (node_filesystem_free_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.1
        for: 5m
        labels:
          severity: critical
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "Low disk space detected"
          description: "Disk space is {{ $value | humanizePercentage }} free on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/low-disk-space"

  # High Priority Alerts
  - name: wazuh-mcp-high
    rules:
      - alert: WazuhMCPHighCPUUsage
        expr: rate(process_cpu_seconds_total{job="wazuh-mcp-servers"}[5m]) > 0.8
        for: 10m
        labels:
          severity: high
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is {{ $value | humanizePercentage }} for {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/high-cpu-usage"

      - alert: WazuhMCPTooManyConnections
        expr: wazuh_mcp_active_connections > 500
        for: 5m
        labels:
          severity: high
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "Too many active connections"
          description: "Active connections: {{ $value }} on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/too-many-connections"

      - alert: WazuhMCPAuthenticationFailures
        expr: rate(wazuh_mcp_auth_failures_total[5m]) > 5
        for: 2m
        labels:
          severity: high
          service: wazuh-mcp-server
          team: security
        annotations:
          summary: "High authentication failure rate"
          description: "Authentication failure rate: {{ $value }} failures/sec on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/auth-failures"

      - alert: WazuhMCPRateLimitExceeded
        expr: rate(wazuh_mcp_rate_limit_exceeded_total[5m]) > 10
        for: 2m
        labels:
          severity: high
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "Rate limit exceeded frequently"
          description: "Rate limit exceeded: {{ $value }} times/sec on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/rate-limit-exceeded"

      - alert: WazuhMCPBackupFailure
        expr: wazuh_mcp_backup_status == 0
        for: 1m
        labels:
          severity: high
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "Backup failed"
          description: "Last backup failed on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/backup-failure"

  # Redis Alerts
  - name: wazuh-mcp-redis
    rules:
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 30s
        labels:
          severity: critical
          service: redis
          team: ops
        annotations:
          summary: "Redis is down"
          description: "Redis instance {{ $labels.instance }} is down"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/redis-down"

      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: high
          service: redis
          team: ops
        annotations:
          summary: "Redis high memory usage"
          description: "Redis memory usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/redis-memory"

      - alert: RedisConnectionsHigh
        expr: redis_connected_clients > 100
        for: 5m
        labels:
          severity: high
          service: redis
          team: ops
        annotations:
          summary: "Redis high connection count"
          description: "Redis has {{ $value }} active connections on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/redis-connections"

      - alert: RedisKeyspaceHitRateLow
        expr: redis_keyspace_hits_total / (redis_keyspace_hits_total + redis_keyspace_misses_total) < 0.8
        for: 10m
        labels:
          severity: medium
          service: redis
          team: ops
        annotations:
          summary: "Redis low hit rate"
          description: "Redis hit rate is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/redis-hit-rate"

      - alert: RedisSlowlogGrowing
        expr: rate(redis_slowlog_length[5m]) > 0
        for: 5m
        labels:
          severity: medium
          service: redis
          team: ops
        annotations:
          summary: "Redis slowlog growing"
          description: "Redis slowlog is growing on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/redis-slowlog"

  # Security Alerts
  - name: wazuh-mcp-security
    rules:
      - alert: WazuhMCPSecurityBreach
        expr: wazuh_mcp_security_violations_total > 0
        for: 0s
        labels:
          severity: critical
          service: wazuh-mcp-server
          team: security
        annotations:
          summary: "Security breach detected"
          description: "Security violation detected on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/security-breach"

      - alert: WazuhMCPBruteForceAttack
        expr: rate(wazuh_mcp_failed_logins_total[5m]) > 20
        for: 2m
        labels:
          severity: high
          service: wazuh-mcp-server
          team: security
        annotations:
          summary: "Potential brute force attack"
          description: "High failed login rate: {{ $value }} failures/sec on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/brute-force"

      - alert: WazuhMCPUnauthorizedAccess
        expr: rate(wazuh_mcp_unauthorized_access_total[5m]) > 5
        for: 2m
        labels:
          severity: high
          service: wazuh-mcp-server
          team: security
        annotations:
          summary: "Unauthorized access attempts"
          description: "Unauthorized access attempts: {{ $value }} attempts/sec on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/unauthorized-access"

      - alert: WazuhMCPSuspiciousActivity
        expr: wazuh_mcp_suspicious_activity_total > 0
        for: 0s
        labels:
          severity: medium
          service: wazuh-mcp-server
          team: security
        annotations:
          summary: "Suspicious activity detected"
          description: "Suspicious activity detected on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/suspicious-activity"

      - alert: WazuhMCPCertificateExpiry
        expr: wazuh_mcp_certificate_expiry_days < 30
        for: 1h
        labels:
          severity: high
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "Certificate expiring soon"
          description: "SSL certificate expires in {{ $value }} days on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/certificate-expiry"

  # Application Performance Alerts
  - name: wazuh-mcp-performance
    rules:
      - alert: WazuhMCPSlowQueries
        expr: rate(wazuh_mcp_slow_queries_total[5m]) > 1
        for: 5m
        labels:
          severity: medium
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "Slow queries detected"
          description: "Slow queries: {{ $value }} queries/sec on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/slow-queries"

      - alert: WazuhMCPHighLatency
        expr: wazuh_mcp_request_latency_seconds > 1
        for: 5m
        labels:
          severity: medium
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "High request latency"
          description: "Request latency is {{ $value }}s on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/high-latency"

      - alert: WazuhMCPQueueBacklog
        expr: wazuh_mcp_queue_size > 1000
        for: 5m
        labels:
          severity: medium
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "Message queue backlog"
          description: "Queue size is {{ $value }} messages on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/queue-backlog"

  # Load Balancer Alerts
  - name: wazuh-mcp-loadbalancer
    rules:
      - alert: HAProxyBackendDown
        expr: haproxy_server_up == 0
        for: 30s
        labels:
          severity: critical
          service: haproxy
          team: ops
        annotations:
          summary: "HAProxy backend server down"
          description: "Backend server {{ $labels.server }} in {{ $labels.backend }} is down"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/haproxy-backend-down"

      - alert: HAProxyHighErrorRate
        expr: rate(haproxy_server_http_responses_total{code="5xx"}[5m]) / rate(haproxy_server_http_responses_total[5m]) > 0.1
        for: 2m
        labels:
          severity: high
          service: haproxy
          team: ops
        annotations:
          summary: "HAProxy high error rate"
          description: "Error rate is {{ $value | humanizePercentage }} for {{ $labels.server }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/haproxy-errors"

      - alert: HAProxyHighResponseTime
        expr: haproxy_server_response_time_average_seconds > 2
        for: 5m
        labels:
          severity: high
          service: haproxy
          team: ops
        annotations:
          summary: "HAProxy high response time"
          description: "Response time is {{ $value }}s for {{ $labels.server }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/haproxy-response-time"

  # Container Alerts
  - name: wazuh-mcp-containers
    rules:
      - alert: ContainerDown
        expr: up{job=~".*container.*"} == 0
        for: 30s
        labels:
          severity: critical
          service: docker
          team: ops
        annotations:
          summary: "Container is down"
          description: "Container {{ $labels.instance }} is down"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/container-down"

      - alert: ContainerHighMemoryUsage
        expr: container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.9
        for: 5m
        labels:
          severity: high
          service: docker
          team: ops
        annotations:
          summary: "Container high memory usage"
          description: "Container {{ $labels.container_label_com_docker_compose_service }} memory usage is {{ $value | humanizePercentage }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/container-memory"

      - alert: ContainerHighCPUUsage
        expr: rate(container_cpu_usage_seconds_total[5m]) > 0.8
        for: 10m
        labels:
          severity: high
          service: docker
          team: ops
        annotations:
          summary: "Container high CPU usage"
          description: "Container {{ $labels.container_label_com_docker_compose_service }} CPU usage is {{ $value | humanizePercentage }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/container-cpu"

      - alert: ContainerRestartLoop
        expr: increase(container_restart_count[1h]) > 5
        for: 5m
        labels:
          severity: high
          service: docker
          team: ops
        annotations:
          summary: "Container restart loop"
          description: "Container {{ $labels.container_label_com_docker_compose_service }} restarted {{ $value }} times in the last hour"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/container-restart-loop"

  # Business Logic Alerts
  - name: wazuh-mcp-business
    rules:
      - alert: WazuhMCPLowThroughput
        expr: rate(wazuh_mcp_requests_total[5m]) < 10
        for: 10m
        labels:
          severity: medium
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "Low request throughput"
          description: "Request rate is {{ $value }} requests/sec on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/low-throughput"

      - alert: WazuhMCPNoRecentActivity
        expr: time() - wazuh_mcp_last_request_timestamp > 300
        for: 5m
        labels:
          severity: medium
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "No recent activity"
          description: "No requests in the last 5 minutes on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/no-activity"

      - alert: WazuhMCPHighErrorRateByEndpoint
        expr: rate(wazuh_mcp_requests_total{status=~"5.."}[5m]) / rate(wazuh_mcp_requests_total[5m]) > 0.2
        for: 5m
        labels:
          severity: high
          service: wazuh-mcp-server
          team: ops
        annotations:
          summary: "High error rate for specific endpoint"
          description: "Error rate is {{ $value | humanizePercentage }} for {{ $labels.endpoint }} on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/endpoint-errors"

  # Infrastructure Alerts
  - name: wazuh-mcp-infrastructure
    rules:
      - alert: DiskIOHigh
        expr: rate(node_disk_io_time_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: high
          service: system
          team: ops
        annotations:
          summary: "High disk I/O"
          description: "Disk I/O is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/high-disk-io"

      - alert: NetworkLatencyHigh
        expr: ping_rtt_ms > 100
        for: 5m
        labels:
          severity: medium
          service: network
          team: ops
        annotations:
          summary: "High network latency"
          description: "Network latency is {{ $value }}ms to {{ $labels.target }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/network-latency"

      - alert: FileDescriptorUsageHigh
        expr: process_open_fds / process_max_fds > 0.8
        for: 5m
        labels:
          severity: high
          service: system
          team: ops
        annotations:
          summary: "High file descriptor usage"
          description: "File descriptor usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/file-descriptors"

  # Monitoring System Alerts
  - name: wazuh-mcp-monitoring
    rules:
      - alert: PrometheusDown
        expr: up{job="prometheus"} == 0
        for: 1m
        labels:
          severity: critical
          service: prometheus
          team: ops
        annotations:
          summary: "Prometheus is down"
          description: "Prometheus instance {{ $labels.instance }} is down"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/prometheus-down"

      - alert: GrafanaDown
        expr: up{job="grafana"} == 0
        for: 1m
        labels:
          severity: high
          service: grafana
          team: ops
        annotations:
          summary: "Grafana is down"
          description: "Grafana instance {{ $labels.instance }} is down"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/grafana-down"

      - alert: AlertmanagerDown
        expr: up{job="alertmanager"} == 0
        for: 1m
        labels:
          severity: critical
          service: alertmanager
          team: ops
        annotations:
          summary: "Alertmanager is down"
          description: "Alertmanager instance {{ $labels.instance }} is down"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/alertmanager-down"

      - alert: MetricsIngestionLag
        expr: prometheus_tsdb_wal_truncations_total - prometheus_tsdb_wal_truncations_total offset 5m == 0
        for: 10m
        labels:
          severity: medium
          service: prometheus
          team: ops
        annotations:
          summary: "Metrics ingestion lag"
          description: "Prometheus metrics ingestion is lagging"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/metrics-lag"

  # Alerting Rules Maintenance
  - name: wazuh-mcp-alerting-health
    rules:
      - alert: AlertingRuleFailure
        expr: increase(prometheus_rule_evaluation_failures_total[5m]) > 0
        for: 1m
        labels:
          severity: medium
          service: prometheus
          team: ops
        annotations:
          summary: "Alerting rule failure"
          description: "Alerting rule {{ $labels.rule_group }}.{{ $labels.rule_name }} is failing"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/alerting-rule-failure"

      - alert: TooManyAlerts
        expr: count(ALERTS{alertstate="firing"}) > 50
        for: 5m
        labels:
          severity: high
          service: alertmanager
          team: ops
        annotations:
          summary: "Too many active alerts"
          description: "There are {{ $value }} active alerts"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/too-many-alerts"

      - alert: AlertmanagerConfigError
        expr: alertmanager_config_last_reload_successful == 0
        for: 1m
        labels:
          severity: high
          service: alertmanager
          team: ops
        annotations:
          summary: "Alertmanager configuration error"
          description: "Alertmanager configuration reload failed"
          runbook_url: "https://docs.wazuh-mcp.local/runbooks/alertmanager-config-error"